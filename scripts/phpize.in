#! /bin/sh

prefix='@prefix@'
phpdir="$prefix/lib/php/build"
includedir="$prefix/include/php"
builddir="`pwd`"

FILES_BUILD="mkdep.awk shtool"
FILES="acinclude.m4 Makefile.global scan_makefile_in.awk"
CLEAN_FILES="$FILES *.lo *.la *.o .deps .libs/ build/ include/ modules/ install-sh \
    mkinstalldirs missing config.nice config.sub config.guess configure configure.in \
	aclocal.m4 config.h config.h.in conftest* ltmain.sh libtool config.cache \
	config.log config.status Makefile Makefile.fragments Makefile.objects"

# Sanity check
if test ! -r config.m4 && test "$1" != "--help"; then
  echo "Cannot find config.m4. "
  echo "Make sure that you run $0 in the top level source directory of the module"
  exit 1
fi

# Usage
case "$args" in 
  --clean)
    # Cleanup
    echo "Cleaning.."
    for i in $CLEAN_FILES; do
      test -e $i && rm -rf $i
    done
    exit 0
    ;;
  --help)
    echo "Usage: $0 [--clean|--help]"
    exit 1
    ;;
esac

test -d build || mkdir build

(cd $phpdir && cp $FILES_BUILD "$builddir"/build)
(cd $phpdir && cp $FILES "$builddir")

sed \
-e "s#@prefix@#$prefix#" \
< $phpdir/phpize.m4 > configure.in

touch install-sh mkinstalldirs missing

aclocal || exit 1
autoconf || exit 1
autoheader || exit 1
libtoolize -f -c || exit 1

# dumping API NOs:
PHP_API_VERSION=`grep -E '#define PHP_API_VERSION' $includedir/main/php.h|sed 's/#define PHP_API_VERSION//'`
ZEND_MODULE_API_NO=`grep -E '#define ZEND_MODULE_API_NO' $includedir/Zend/zend_modules.h|sed 's/#define ZEND_MODULE_API_NO//'`
ZEND_EXTENSION_API_NO=`grep -E '#define ZEND_EXTENSION_API_NO' $includedir/Zend/zend_extensions.h|sed 's/#define ZEND_EXTENSION_API_NO//'`

echo "Configuring for:"
echo "  PHP Api Version:  "$PHP_API_VERSION
echo "  Zend Module Api No:  "$ZEND_MODULE_API_NO
echo "  Zend Extension Api No:  "$ZEND_EXTENSION_API_NO

exit 0

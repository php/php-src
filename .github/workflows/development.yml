name: Development

on: [push]

jobs:
  test:
    name: Test
    runs-on: ubuntu-20.04
    steps:
      - name: APT
        run: |
          sudo apt install bison \
            re2c \
            locales \
            ldap-utils \
            openssl \
            slapd \
            language-pack-de \
            libgmp-dev \
            libicu-dev \
            libtidy-dev \
            libenchant-dev \
            libaspell-dev \
            libpspell-dev \
            libsasl2-dev \
            libxpm-dev \
            libzip-dev \
            libsqlite3-dev \
            libwebp-dev \
            libonig-dev \
            libkrb5-dev \
            libgssapi-krb5-2 \
            libcurl4-openssl-dev \
            libxml2-dev \
            libxslt1-dev \
            libpq-dev \
            libreadline-dev \
            libldap2-dev \
            libsodium-dev \
            libargon2-0-dev \
            libmm-dev \
            libsnmp-dev \
            postgresql \
            postgresql-contrib \
            snmpd \
            snmp-mibs-downloader \
            freetds-dev \
            unixodbc-dev \
            llvm \
            libc-client-dev \
            dovecot-core \
            dovecot-pop3d \
            dovecot-imapd \
            sendmail \
            firebird-dev \
            liblmdb-dev \
            libtokyocabinet-dev \
            libdb-dev \
            libqdbm-dev \
            libjpeg-dev \
            libpng-dev \
            libfreetype6-dev

      - name: "Checkout repository"
        uses: actions/checkout@v2

      - name: Configure Build
        run: |
          ./buildconf --force
          ./configure ${{ parameters.configurationParameters }} \
            --enable-option-checking=fatal \
            --prefix=/usr \
            --enable-phpdbg \
            --enable-fpm \
            --with-pdo-mysql=mysqlnd \
            --with-mysqli=mysqlnd \
            --with-pgsql \
            --with-pdo-pgsql \
            --with-pdo-sqlite \
            --enable-intl \
            --without-pear \
            --enable-gd \
            --with-jpeg \
            --with-webp \
            --with-freetype \
            --with-xpm \
            --enable-exif \
            --with-zip \
            --with-zlib \
            --with-zlib-dir=/usr \
            --enable-soap \
            --enable-xmlreader \
            --with-xsl \
            --with-tidy \
            --enable-sysvsem \
            --enable-sysvshm \
            --enable-shmop \
            --enable-pcntl \
            --with-readline \
            --enable-mbstring \
            --with-curl \
            --with-gettext \
            --enable-sockets \
            --with-bz2 \
            --with-openssl \
            --with-gmp \
            --enable-bcmath \
            --enable-calendar \
            --enable-ftp \
            --with-pspell=/usr \
            --with-enchant=/usr \
            --with-kerberos \
            --enable-sysvmsg \
            --with-ffi \
            --enable-zend-test \
            --with-ldap \
            --with-ldap-sasl \
            --with-password-argon2 \
            --with-mhash \
            --with-sodium \
            --enable-dba \
            --with-cdb \
            --enable-flatfile \
            --enable-inifile \
            --with-tcadb \
            --with-lmdb \
            --with-qdbm \
            --with-snmp \
            --with-unixODBC \
            --with-imap \
            --with-kerberos \
            --with-imap-ssl \
            --with-pdo-odbc=unixODBC,/usr \
            --with-pdo-firebird \
            --with-pdo-dblib \
            --with-pdo-oci=shared,instantclient,/opt/oracle/instantclient \
            --with-oci8=shared,instantclient,/opt/oracle/instantclient \
            --enable-werror \
            --with-config-file-path=/etc \
            --with-config-file-scan-dir=/etc/php.d

      - name: Configure Build
        run: make -j$(/usr/bin/nproc) >/dev/null

      - name: Install Build
        run: |
          set -e
          sudo make install
          sudo mkdir     /etc/php.d
          sudo chmod 777 /etc/php.d
          echo mysqli.default_socket=/var/run/mysqld/mysqld.sock    > /etc/php.d/mysqli.ini
          echo pdo_mysql.default_socket=/var/run/mysqld/mysqld.sock > /etc/php.d/pdo_mysql.ini
          echo opcache.enable_cli=1 >> /etc/php.d/opcache.ini
          echo opcache.protect_memory=1 >> /etc/php.d/opcache.ini

      - name: Test
        run: |
          export MYSQL_TEST_USER=root
          export MYSQL_TEST_PASSWD=root
          export PDO_MYSQL_TEST_DSN="mysql:host=localhost;dbname=test"
          export PDO_MYSQL_TEST_USER=root
          export PDO_MYSQL_TEST_PASS=root
          export PDO_DBLIB_TEST_DSN="dblib:host=127.0.0.1;dbname=master;version=7.0"
          export PDO_DBLIB_TEST_USER="pdo_test"
          export PDO_DBLIB_TEST_PASS="password"
          export TEST_PHP_JUNIT=junit.xml
          export REPORT_EXIT_STATUS=no
          export SKIP_IO_CAPTURE_TESTS=1
          rm -rf junit.xml | true
          sapi/cli/php run-tests.php -P -q \
              -j$(/usr/bin/nproc) \
              -g FAIL,XFAIL,BORK,WARN,LEAK,XLEAK,SKIP \
              --offline \
              --show-diff \
              --show-slow 1000 \
              --set-timeout 120
